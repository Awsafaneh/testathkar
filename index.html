<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>تطبيق الأذكار والصلاة</title>

    <meta name="theme-color" content="#1C1C1E">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="logoa.png" type="image/png">
    <link rel="apple-touch-icon" href="logoa.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #2c6959;
            --secondary-color: #1e4b3f;
            --accent-color: #d4ac6e;
            --text-color: #333;
            --bg-color: #f7f9f8;
            --white-color: #ffffff;
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-dark: rgba(0, 0, 0, 0.1);
            --font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --qibla-bg: #1C1C1E;
            --qibla-dial-bg: #2C2C2E;
            --qibla-yellow: #FFD700;
        }
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--text-color);
            line-height: 1.7;
        }
        .container { max-width: 1100px; margin: 0 auto; padding: 1rem; }

        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            color: var(--white-color);
            margin-bottom: 2rem;
            animation: fadeInDown 1s ease-out;
        }
        .header-logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .header h1 {
            font-size: clamp(2rem, 5vw, 2.8rem);
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .header p {
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            opacity: 0.9;
        }

        .navigation-container {
            position: relative;
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .menu-toggle {
            display: none;
            background: var(--white-color);
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 4px 15px var(--shadow-dark);
        }
        .menu-toggle svg { width: 24px; height: 24px; color: var(--primary-color); }
        
        .navigation {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            transition: all 0.3s ease-in-out;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--white-color);
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            font-family: var(--font-family);
            color: var(--primary-color);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow-dark);
        }
        .nav-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--shadow-dark);
        }
        .nav-btn.active {
            background: var(--accent-color);
            color: var(--text-color);
            font-weight: 700;
        }
        .nav-btn svg { width: 20px; height: 20px; }

        @media (max-width: 768px) {
            .menu-toggle { display: block; }
            .navigation {
                display: none;
                position: absolute;
                top: 60px;
                left: 50%;
                transform: translateX(-50%);
                flex-direction: column;
                background-color: var(--white-color);
                width: 90%;
                max-width: 300px;
                border-radius: 15px;
                padding: 1rem;
                box-shadow: 0 10px 30px rgba(0,0,0,0.15);
                z-index: 1000;
            }
            .navigation.active {
                display: flex;
            }
        }
        
        .page { display: none; animation: fadeIn 0.5s ease-out; }
        .page.active { display: block; }

        .card {
            background: var(--white-color);
            border-radius: 20px;
            padding: clamp(1.5rem, 4vw, 2rem);
            box-shadow: 0 10px 40px var(--shadow-light);
            margin-bottom: 1.5rem;
        }
        #qibla-page .card {
             background-color: var(--qibla-bg);
             color: var(--white-color);
        }

        .card-title {
            font-size: clamp(1.5rem, 4vw, 1.8rem);
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 1.5rem;
            text-align: center;
        }
         #qibla-page .card-title {
            color: var(--white-color);
         }

        .prayer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }
        .prayer-item {
            background: linear-gradient(145deg, var(--bg-color), #eaf2f0);
            border: 1px solid #e0e0e0;
            padding: 1.2rem;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .prayer-item.next-prayer {
            transform: translateY(-5px);
            background: var(--primary-color);
            color: var(--white-color);
            box-shadow: 0 8px 20px rgba(44, 105, 89, 0.3);
        }
        .prayer-item.next-prayer .prayer-name,
        .prayer-item.next-prayer .prayer-time {
            color: var(--white-color);
        }
        .prayer-name { font-weight: 700; font-size: 1.1rem; color: var(--secondary-color); margin-bottom: 0.5rem; }
        .prayer-time { font-weight: 700; font-size: 1.3rem; color: var(--text-color); font-family: monospace; }

        .home-dashboard { text-align: center; }
        .home-dashboard h3 { font-size: 1.2rem; color: var(--secondary-color); margin-bottom: 1rem; }
        #next-prayer-countdown { font-size: 2rem; font-weight: 700; color: var(--primary-color); margin-bottom: 1.5rem; font-family: monospace; }
        #verse-of-the-day { border-top: 1px solid #eee; padding-top: 1.5rem; }
        #verse-of-the-day .verse-text { font-family: 'Amiri', serif; font-size: 1.4rem; margin-bottom: 0.5rem; font-style: italic; color: var(--secondary-color); }
        #verse-of-the-day .verse-surah { font-size: 1rem; color: #777; }
        #location-info-container { 
            text-align: center; 
            margin-top: 1.5rem; 
            padding-top: 1rem; 
            border-top: 1px solid #eee; 
            font-size: 0.9rem; 
            color: #888;
            min-height: 20px; /* Added to prevent layout shift */
        }

        .content-section {
            max-height: 70vh;
            overflow-y: auto;
            padding: 5px;
        }
        .content-section-inner { padding: 1rem; }
        .content-section::-webkit-scrollbar { width: 8px; }
        .content-section::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .content-section::-webkit-scrollbar-thumb { background: linear-gradient(135deg, var(--accent-color), var(--primary-color)); border-radius: 10px; }

        .sub-navigation {
            display: flex; justify-content: center; gap: 10px;
            margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #eee;
            flex-wrap: wrap;
        }
        .sub-nav-btn {
            background: #e8f0ed; border: 1px solid transparent; color: var(--primary-color);
            padding: 10px 20px; border-radius: 20px; cursor: pointer;
            font-weight: 500; transition: all 0.3s ease; font-family: var(--font-family);
        }
        .sub-nav-btn.active, .sub-nav-btn:hover {
            background: var(--primary-color); color: var(--white-color);
            transform: translateY(-2px); box-shadow: 0 4px 10px var(--shadow-light);
        }
        .azkar-section, .deceased-section { display: none; }
        .azkar-section.active, .deceased-section.active { display: block; animation: fadeIn 0.5s; }

        .dua-item, .azkar-item {
            background: var(--bg-color); border-radius: 15px; padding: 1.5rem;
            margin-bottom: 1rem; border-right: 5px solid var(--accent-color);
            border-left: none;
            transition: all 0.3s ease;
        }
        .azkar-text, .dua-text { font-size: 1.2rem; line-height: 1.8; color: var(--text-color); }
        .azkar-source { font-size: 0.9rem; color: #888; margin-top: 1rem; font-style: italic; }
        .azkar-count {
            display: inline-block;
            background: var(--accent-color);
            color: #fff;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 700;
            margin-top: 1rem;
            margin-right: 5px;
        }

        .counter {
            display: flex; align-items: center; justify-content: center;
            gap: 15px; margin-top: 15px;
        }
        .tasabih-counter-btn {
            background: transparent; border:none; cursor: pointer;
            font-size: 2rem; color: var(--primary-color);
            transition: transform 0.2s ease;
        }
        .tasabih-counter-btn:hover { transform: scale(1.2); }
        .tasabih-counter-display {
            font-size: 1.2rem; font-weight: 700; color: var(--secondary-color);
            background: #e8f0ed; padding: 8px 20px; border-radius: 10px;
            min-width: 100px; text-align:center;
        }

        #quran-index {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        .surah-btn {
            display: flex; align-items: center; background: var(--bg-color); border: 1px solid #e0e0e0;
            padding: 1rem; border-radius: 10px; cursor: pointer; text-align: right; transition: all 0.3s ease;
            font-size: 1.1rem; font-weight: 500; font-family: var(--font-family);
        }
        .surah-btn:hover { transform: translateY(-3px); border-color: var(--primary-color); }
        .surah-btn .surah-number {
            background: var(--primary-color); color: var(--white-color); border-radius: 8px;
            padding: 5px 10px; font-weight: 700; margin-left: 1rem;
        }
        .surah-details { flex-grow: 1; }
        .surah-details span { font-size: 0.85rem; color: #777; display: block; }
        #quran-viewer { display: none; }
        #surah-bismillah { font-family: 'Amiri', 'Times New Roman', serif; }
        .ayah { font-family: 'Amiri', 'Times New Roman', serif; font-size: 1.5rem; line-height: 2.5; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .ayah-number {
            font-family: var(--font-family);
            background-color: var(--accent-color); color: var(--secondary-color); border-radius: 50%;
            width: 30px; height: 30px; display: inline-block; text-align: center; line-height: 30px;
            font-size: 1rem; margin-right: 10px;
        }
        .back-to-index-btn { margin-bottom: 1rem !important; }

        /* New Qibla Design */
        .qibla-container-new {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            min-height: 70vh;
            padding: 1rem 0;
        }
        .qibla-header-text {
            color: #aaa;
            font-size: 1.2rem;
            text-align: center;
        }
        .compass-main {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem 0;
        }
        .dial {
            width: 100%;
            height: 100%;
            background-color: var(--qibla-dial-bg);
            border-radius: 50%;
            transition: transform 0.4s ease-out;
            position: relative;
            border: 4px solid #444;
        }
        .dial-ticks {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-image: 
                repeating-conic-gradient(from 0deg, 
                    rgba(255,255,255,0.5) 0deg 0.5deg, 
                    transparent 0.5deg 8.5deg,
                    rgba(255,255,255,0.2) 8.5deg 9.5deg,
                    transparent 9.5deg 10deg
                );
        }
        .dial .point {
            position: absolute;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .point.north { top: 10px; left: 50%; transform: translateX(-50%); }
        .point.east { top: 50%; right: 15px; transform: translateY(-50%); }
        .point.south { bottom: 10px; left: 50%; transform: translateX(-50%); }
        .point.west { top: 50%; left: 15px; transform: translateY(-50%); }

        #kaaba-marker-new {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            transform-origin: center;
        }
        .static-arrow-container {
            position: absolute;
            width: 120px;
            height: 120px;
            background-color: var(--qibla-yellow);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .static-arrow-container::before { /* The black arrow */
            content: '';
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-bottom: 50px solid black;
            margin-top: -15px;
        }

        .status-text {
            color: white;
            font-size: 1.2rem;
            font-weight: 500;
            text-align: center;
            height: 40px;
        }

        #qibla-permission-btn {
            background: var(--qibla-yellow); color: black; padding: 10px 20px;
            border-radius: 20px; border: none; cursor: pointer; margin-top: 1rem; font-weight: bold;
        }
 
        .site-footer {
            text-align: center;
            padding: 2rem 1rem 1rem 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            margin-top: 2rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        .site-footer strong {
            font-weight: 700;
            color: var(--white-color);
        }

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div class="container">
        <svg width="0" height="0" style="position:absolute;">
            <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></symbol>
            <symbol id="icon-quran" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></symbol>
            <symbol id="icon-beads" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 10a2 2 0 1 0 4 0 2 2 0 0 0-4 0Z"/><path d="M10.29 3.86a2 2 0 1 0 2.83 2.83A2 2 0 0 0 10.29 3.86Z"/><path d="M14 10a2 2 0 1 0 4 0 2 2 0 0 0-4 0Z"/><path d="M18.14 16.71a2 2 0 1 0 2.83-2.83 2 2 0 0 0-2.83 2.83Z"/><path d="M6 18a2 2 0 1 0-4 0 2 2 0 0 0 4 0Z"/><path d="M10.29 20.14a2 2 0 1 0 2.83-2.83 2 2 0 0 0-2.83 2.83Z"/><path d="M12 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M6 12a2 2 0 1 0-4 0 2 2 0 0 0 4 0Z"/><path d="M18.14 6.71a2 2 0 1 0 2.83-2.83 2 2 0 0 0-2.83 2.83Z"/></symbol>
            <symbol id="icon-hands" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 10h1v1a2 2 0 0 0 4 0V5a3 3 0 0 0-6 0v1a2 2 0 0 0 4 0V5"/><path d="M17 10h1v1a2 2 0 0 0 4 0V5a3 3 0 0 0-6 0v1a2 2 0 0 0 4 0V5"/></symbol>
            <symbol id="icon-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></symbol>
            <symbol id="icon-qibla" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 2 7 19-7-4-7 4 7-19z"/><circle cx="12" cy="12" r="10"/></symbol>
            <symbol id="icon-menu" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></symbol>
            <symbol id="icon-kaaba" viewBox="0 0 48 48"><path fill="#FFD700" d="M7.1,43.3l11.4-29l10.8,29L7.1,43.3z M24.1,5.2l-4.2,10.9h8.2L24.1,5.2z M40.7,43.3L29.2,14.3l11.4,29H40.7z"/></symbol>
        </svg>

        <header class="header">
            <img src="logoa.png" alt="شعار الموقع" class="header-logo">
            <h1>تطبيق الأذكار والصلاة</h1>
            <p>اللهم اعنا على ذكرك وشكرك وحسن عبادتك</p>
            <h4> صدقة جارية عن روح المرحوم الحاج نمر عفانه (ابو بسام) والمرحومة الحاجة عائشة الحمد (ام بسام)</h4>
        </header>

        <nav class="navigation-container">
            <button class="menu-toggle" onclick="toggleMenu()">
                <svg><use href="#icon-menu"></use></svg>
            </button>
            <div class="navigation" id="main-nav">
                <button class="nav-btn active" onclick="showPage('home')"><svg><use href="#icon-home"></use></svg>الرئيسية</button>
                <button class="nav-btn" onclick="showPage('qibla')"><svg><use href="#icon-qibla"></use></svg>القبلة</button>
                <button class="nav-btn" onclick="showPage('quran')"><svg><use href="#icon-quran"></use></svg>المصحف</button>
                <button class="nav-btn" onclick="showPage('azkar')"><svg><use href="#icon-beads"></use></svg>الأذكار</button>
                <button class="nav-btn" onclick="showPage('deceased')"><svg><use href="#icon-hands"></use></svg>أدعية للمتوفين</button>
                <button class="nav-btn" onclick="showPage('general')"><svg><use href="#icon-star"></use></svg>أدعية عامة</button>
            </div>
        </nav>

        <div id="home-page" class="page active">
            <div class="card">
                <h2 class="card-title">مواقيت الصلاة</h2>
                <div class="prayer-grid">
                    <div class="prayer-item" id="prayer-Fajr"><div class="prayer-name">الفجر</div><div class="prayer-time" id="fajr-time">--:--</div></div>
                    <div class="prayer-item" id="prayer-Sunrise"><div class="prayer-name">الشروق</div><div class="prayer-time" id="sunrise-time">--:--</div></div>
                    <div class="prayer-item" id="prayer-Dhuhr"><div class="prayer-name">الظهر</div><div class="prayer-time" id="dhuhr-time">--:--</div></div>
                    <div class="prayer-item" id="prayer-Asr"><div class="prayer-name">العصر</div><div class="prayer-time" id="asr-time">--:--</div></div>
                    <div class="prayer-item" id="prayer-Maghrib"><div class="prayer-name">المغرب</div><div class="prayer-time" id="maghrib-time">--:--</div></div>
                    <div class="prayer-item" id="prayer-Isha"><div class="prayer-name">العشاء</div><div class="prayer-time" id="isha-time">--:--</div></div>
                </div>
                <div id="location-info-container">
                    <div id="location-status">جاري تحديد موقعك...</div>
                    </div>
            </div>
            <div class="card home-dashboard">
                <h3>⏳ الصلاة القادمة بعد</h3>
                <div id="next-prayer-countdown">جاري الحساب...</div>
                <div id="verse-of-the-day">
                    <h3>✨ آية اليوم</h3>
                    <p class="verse-text"></p>
                    <p class="verse-surah"></p>
                </div>
            </div>
        </div>

        <div id="qibla-page" class="page">
             <div class="card">
                <div class="qibla-container-new">
                    <div class="qibla-header-text">اتجاه القبلة في <span id="qibla-city">جاري التحديد...</span></div>
                     <div id="qibla-permission-container" class="status-text"></div>
                    <div class="compass-main">
                        <div class="static-arrow-container"></div>
                        <div id="compass-dial-new" class="dial">
                            <div class="dial-ticks"></div>
                            <div class="point north">شمال</div>
                            <div class="point east">شرق</div>
                            <div class="point south">جنوب</div>
                            <div class="point west">غرب</div>
                            <div id="kaaba-marker-new">
                                <svg viewbox="0 0 48 48" width="40" height="40"><use href="#icon-kaaba"></use></svg>
                            </div>
                        </div>
                    </div>
                    <div id="qibla-status-new" class="status-text"></div>
                </div>
            </div>
        </div>
        
        <div id="quran-page" class="page">
            <div class="card">
                <div id="quran-viewer">
                    <button class="sub-nav-btn back-to-index-btn" onclick="showQuranIndex()">العودة إلى الفهرس</button>
                    <h3 id="surah-title" class="card-title" style="margin-top: 1.5rem;"></h3>
                    <p id="surah-bismillah" style="text-align: center; font-size: 1.8rem; margin-bottom: 20px;"></p>
                    <div id="surah-content" class="content-section" style="max-height: 60vh;"></div>
                </div>
                <div id="quran-index-container">
                    <h2 class="card-title">فهرس المصحف الشريف</h2>
                    <div id="quran-index-loader" style="text-align:center; font-size: 1.2rem;">جاري تحميل فهرس السور...</div>
                    <div id="quran-index" class="content-section" style="max-height: 65vh;"></div>
                </div>
            </div>
        </div>
        
        <div id="azkar-page" class="page">
            <div class="card">
                <h2 class="card-title">حصن المسلم</h2>
                <nav class="sub-navigation">
                    <button class="sub-nav-btn active" onclick="showAzkarSection('sabah', this)">أذكار الصباح</button>
                    <button class="sub-nav-btn" onclick="showAzkarSection('masaa', this)">أذكار المساء</button>
                    <button class="sub-nav-btn" onclick="showAzkarSection('wake', this)">أذكار الاستيقاظ</button>
                    <button class="sub-nav-btn" onclick="showAzkarSection('sleep', this)">أذكار النوم</button>
                    <button class="sub-nav-btn" onclick="showAzkarSection('salah', this)">أذكار بعد الصلاة</button>
                    <button class="sub-nav-btn" onclick="showAzkarSection('misc', this)">أذكار متفرقة</button>
                    <button class="sub-nav-btn" onclick="showAzkarSection('tasabih', this)">تسابيح</button>
                </nav>
                <div class="content-section">
                    <div class="content-section-inner">
                        <div id="azkar-sabah" class="azkar-section active"></div>
                        <div id="azkar-masaa" class="azkar-section"></div>
                        <div id="azkar-wake" class="azkar-section"></div>
                        <div id="azkar-sleep" class="azkar-section"></div>
                        <div id="azkar-salah" class="azkar-section"></div>
                        <div id="azkar-misc" class="azkar-section"></div>
                        <div id="azkar-tasabih" class="azkar-section"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="deceased-page" class="page">
                 <div class="card">
                    <h2 class="card-title">أدعية للمتوفين</h2>
                    <nav class="sub-navigation deceased-nav">
                        <button class="sub-nav-btn active" onclick="showDeceased('nimer', this)">نمر محمد عفانه</button>
                        <button class="sub-nav-btn" onclick="showDeceased('aisha', this)">عائشة عواد الحمد</button>
                        <button class="sub-nav-btn" onclick="showDeceased('bashar', this)">بشار نمر عفانه</button>
                        <button class="sub-nav-btn" onclick="showDeceased('basma', this)">باسمة نمر عفانه</button>
                    </nav>
                    <div class="content-section">
                        <div class="content-section-inner">
                            <div id="deceased-nimer" class="deceased-section active"></div>
                            <div id="deceased-aisha" class="deceased-section"></div>
                            <div id="deceased-bashar" class="deceased-section"></div>
                            <div id="deceased-basma" class="deceased-section"></div>
                        </div>
                    </div>
                 </div>
        </div>
        
        <div id="general-page" class="page">
                 <div class="card">
                    <h2 class="card-title">أدعية عامة وشاملة</h2>
                    <div class="content-section">
                        <div class="content-section-inner" id="general-duas-container"></div>
                    </div>
                 </div>
        </div>

        <footer class="site-footer">
            <p>&copy; <span id="current-year"></span> - Made by <strong>Aws Afaneh</strong></p>
        </footer>
    </div>

<script>
// --- START OF JAVASCRIPT ---

// --- 1. DATA & CONSTANTS ---
const KABA_LAT = 21.4225;
const KABA_LON = 39.8262;
let prayerTimesData = {};
let nextPrayerInterval;
let orientationHandler = null; // To control the compass listener

// --- 2. INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    initPrayerTimesBasedOnLocation();
    document.getElementById('current-year').textContent = new Date().getFullYear();
    setTimeout(() => {
        populateAllDynamicContent();
    }, 500);
});


// --- 3. UI & NAVIGATION FUNCTIONS ---
function toggleMenu() { document.getElementById('main-nav').classList.toggle('active'); }

function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`${pageId}-page`).classList.add('active');
    document.querySelector(`.nav-btn[onclick="showPage('${pageId}')"]`).classList.add('active');
    
    if (pageId === 'qibla') {
        initNewQibla();
    } else {
        stopQibla();
    }

    if (window.innerWidth <= 768) { 
        const nav = document.getElementById('main-nav');
        if (nav.classList.contains('active')) {
            nav.classList.remove('active');
        }
    }
}

function showAzkarSection(sectionId, btn) {
    document.querySelectorAll('.azkar-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('#azkar-page .sub-nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`azkar-${sectionId}`).classList.add('active');
    btn.classList.add('active');
}
    
function showDeceased(deceasedId, btn) {
    document.querySelectorAll('.deceased-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('#deceased-page .sub-nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`deceased-${deceasedId}`).classList.add('active');
    btn.classList.add('active');
}

// --- 4. DATA POPULATION ---
function populateAllDynamicContent() {
    populateDeceasedDuas();
    populateGeneralDuas();
    populateAzkar();
    loadQuranIndex();
    displayVerseOfTheDay();
    loadAllTasabihCounters();
}

function displayVerseOfTheDay() {
    const allVerses = [ { text: "أَلَا بِذِكْرِ اللَّهِ تَطْمَئِنُّ الْقُلُوبُ", surah: "(الرعد: 28)" }, { text: "فَاذْكُرُونِي أَذْكُرْكُمْ وَاشْكُرُوا لِي وَلَا تَكْفُرُونِ", surah: "(البقرة: 152)" }, { text: "وَقَالَ رَبُّكُمُ ادْعُونِي أَسْتَجِبْ لَكُمْ", surah: "(غافر: 60)" } ];
    const randomVerse = allVerses[Math.floor(Math.random() * allVerses.length)];
    const verseTextEl = document.querySelector('#verse-of-the-day .verse-text');
    const verseSurahEl = document.querySelector('#verse-of-the-day .verse-surah');
    if (verseTextEl && verseSurahEl) {
        verseTextEl.textContent = `"${randomVerse.text}"`;
        verseSurahEl.textContent = randomVerse.surah;
    }
}

function populateAzkar() {
    const azkarData = {
        sabah: [
            { text: "أَعُوذُ بِاللهِ مِنْ الشَّيْطَانِ الرَّجِيمِ ﴿اللَّهُ لاَ إِلَهَ إِلاَّ هُوَ الْحَيُّ الْقَيُّومُ...﴾ - آية الكرسي.", count: "مرة واحدة", source: "من قالها حين يصبح أجير من الجن حتى يمسي." },
            { text: "قراءة سورة الإخلاص، والفلق، والناس.", count: "ثلاث مرات", source: "من قالها ثلاث مرات حين يصبح وحين يمسي كفته من كل شيء." },
            { text: "أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لاَ إِلَهَ إِلاَّ اللَّهُ وَحْدَهُ لاَ شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ, رَبِّ أَسْأَلُكَ خَيْرَ مَا فِي هَذَا الْيَوْمِ وَخَيْرَ مَا بَعْدَهُ، وَأَعُوذُ بِكَ مِنْ شَرِّ مَا فِي هَذَا الْيَوْمِ وَشَرِّ مَا بَعْدَهُ، رَبِّ أَعُوذُ بِكَ مِنَ الْكَسَلِ وَسُوءِ الْكِبَرِ، رَبِّ أَعُوذُ بِكَ مِنْ عَذَابٍ فِي النَّارِ وَعَذَابٍ فِي الْقَبْرِ.", count: "مرة واحدة" },
            { text: "اللَّهُمَّ بِكَ أَصْبَحْنَا، وَبِكَ أَمْسَيْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ وَإِلَيْكَ النُّشُورُ.", count: "مرة واحدة" },
            { text: "اللَّهُمَّ أَنْتَ رَبِّي لاَ إِلَهَ إِلاَّ أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ، أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ بِذَنْبِي فَاغْفِرْ لِي فَإِنَّهُ لاَ يَغْفِرُ الذُّنوبَ إِلاَّ أَنْتَ.", count: "مرة واحدة", source: "سيد الاستغفار" },
            { text: "اللَّهُمَّ عَافِنِي فِي بَدَنِي، اللَّهُمَّ عَافِنِي فِي سَمْعِي، اللَّهُمَّ عَافِنِي فِي بَصَرِي، لاَ إِلَهَ إِلاَّ أَنْتَ. اللَّهُمَّ  إِنِّي أَعُوذُ بِكَ مِنَ الْكُفْرِ، وَالْفَقْرِ، وَأَعُوذُ بِكَ مِنْ عَذَابِ الْقَبْرِ، لاَ إِلَهَ إِلاَّ أَنْتَ.", count: "ثلاث مرات" },
            { text: "اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَفْوَ وَالْعَافِيَةَ فِي الدُّنْيَا وَالآخِرَةِ، اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَفْوَ وَالْعَافِيَةَ فِي دِينِي وَدُنْيَايَ وَأَهْلِي، وَمَالِي، اللَّهُمَّ اسْتُرْ عَوْرَاتِي، وَآمِنْ رَوْعَاتِي، اللَّهُمَّ احْفَظْنِي مِنْ بَيْنِ يَدَيَّ، وَمِنْ خَلْفِي، وَعَنْ يَمِينِي، وَعَنْ شِمَالِي، وَمِنْ فَوْقِي، وَأَعُوذُ بِعَظَمَتِكَ أَنْ أُغْتَالَ مِنْ تَحْتِي.", count: "مرة واحدة" },
            { text: "بِسْمِ اللَّهِ الَّذِي لاَ يَضُرُّ مَعَ اسْمِهِ شَيْءٌ فِي الأَرْضِ وَلاَ فِي السّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ.", count: "ثلاث مرات" },
            { text: "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ: عَدَدَ خَلْقِهِ، وَرِضَا نَفْسِهِ، وَزِنَةَ عَرْشِهِ، وَمِدَادَ كَلِمَاتِهِ.", count: "ثلاث مرات" },
            { text: "يَا حَيُّ يَا قَيُّومُ بِرَحْمَتِكَ أَسْتَغِيثُ أَصْلِحْ لِي شَأْنِي كُلَّهُ وَلاَ تَكِلْنِي إِلَى نَفْسِي طَرْفَةَ عَيْنٍ.", count: "مرة واحدة" }
        ],
        masaa: [
            { text: "أَعُوذُ بِاللهِ مِنْ الشَّيْطَانِ الرَّجِيمِ ﴿اللَّهُ لاَ إِلَهَ إِلاَّ هُوَ الْحَيُّ الْقَيُّومُ...﴾ - آية الكرسي.", count: "مرة واحدة", source: "من قالها حين يمسي أجير من الجن حتى يصبح." },
            { text: "قراءة سورة الإخلاص، والفلق، والناس.", count: "ثلاث مرات", source: "تكفيه من كل شيء." },
            { text: "أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لاَ إِلَهَ إِلاَّ اللَّهُ وَحْدَهُ لاَ شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ، رَبِّ أَسْأَلُكَ خَيْرَ مَا فِي هَذِهِ اللَّيْلَةِ وَخَيْرَ مَا بَعْدَهَا، وَأَعُوذُ بِكَ مِنْ شَرِّ مَا فِي هَذِهِ اللَّيْلَةِ وَشَرِّ مَا بَعْدَهَا، رَبِّ أَعُوذُ بِكَ مِنَ الْكَسَلِ وَسُوءِ الْكِبَرِ، رَبِّ أَعُوذُ بِكَ مِنْ عَذَابٍ فِي النَّارِ وَعَذَابٍ فِي الْقَبْرِ.", count: "مرة واحدة" },
            { text: "اللَّهُمَّ بِكَ أَمْسَيْنَا، وَبِكَ أَصْبَحْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ وَإِلَيْكَ الْمَصِيرُ.", count: "مرة واحدة" },
            { text: "اللَّهُمَّ مَا أَمْسَى بِي مِنْ نِعْمَةٍ أَوْ بِأَحَدٍ مِنْ خَلْقِكَ فَمِنْكَ وَحْدَكَ لاَ شَرِيكَ لَكَ، فَلَكَ الْحَمْدُ وَلَكَ الشُّكْرُ.", count: "مرة واحدة" },
            { text: "اللَّهُمَّ إِنِّي أَمْسَيْتُ أُشْهِدُكَ، وَأُشْهِدُ حَمَلَةَ عَرْشِكَ، وَمَلاَئِكَتَكَ، وَجَمِيعَ خَلْقِكَ، أَنَّكَ أَنْتَ اللَّهُ لاَ إِلَهَ إِلاَّ أَنْتَ وَحْدَكَ لاَ شَرِيكَ لَكَ، وَأَنَّ مُحَمَّداً عَبْدُكَ وَرَسُولُكَ.", count: "أربع مرات" },
            { text: "بِسْمِ اللَّهِ الَّذِي لاَ يَضُرُّ مَعَ اسْمِهِ شَيْءٌ فِي الأَرْضِ وَلاَ فِي السّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ.", count: "ثلاث مرات" },
            { text: "أَعُوذُ بِكَلِمَاتِ اللَّهِ التَّامَّاتِ مِنْ شَرِّ مَا خَلَقَ.", count: "ثلاث مرات" },
            { text: "رَضِيتُ بِاللَّهِ رَبَّاً، وَبِالإِسْلاَمِ دِيناً، وَبِمُحَمَّدٍ صلى الله عليه وسلم نَبِيّاً.", count: "ثلاث مرات" },
            { text: "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ.", count: "مائة مرة", source: "لم يأت أحد يوم القيامة بأفضل مما جاء به، إلا أحد قال مثل ما قال أو زاد عليه." }
        ],
        wake: [
            { text: "الْحَمْـدُ لِلّهِ الّذي أَحْـيانا بَعْـدَ ما أَماتَـنا وَإليه النُّـشور.", count: "مرة واحدة" },
            { text: "لا إله إلا الله وحده لا شريك له، له الملك وله الحمد، وهو على كل شيء قدير.", count: "مرة واحدة" },
            { text: "الْحَمْدُ لِلَّهِ الَّذِي عَافَانِي فِي جَسَدِي، وَرَدَّ عَلَيَّ رُوحِي، وَأَذِنَ لِي بِذِكْرِهِ.", count: "مرة واحدة" },
            { text: "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ، سُبْحَانَ اللَّهِ الْعَظِيمِ.", count: "مرة واحدة" },
            { text: "قراءة آخر عشر آيات من سورة آل عمران.", count: "مرة واحدة" },
            { text: "اللهم اغفر لي.", count: "مرة واحدة" },
            { text: "أستغفر الله.", count: "مرة واحدة" },
            { text: "اللهم بك أصبحنا وبك أمسينا وبك نحيا وبك نموت وإليك النشور.", count: "مرة واحدة" },
            { text: "الحمد لله الذي أقالنا يومنا هذا ولم يهلكنا بذنوبنا.", count: "مرة واحدة" },
            { text: "الحمد لله الذي كَساني هذا (الثوب) ورَزَقَنيه من غير حولٍ مني ولا قوة.", count: "مرة واحدة" }
        ],
        sleep: [
            { text: "بِاسْـمِكَ اللّهُـمَّ أَمـوتُ وَأَحْـيا.", count: "مرة واحدة" },
            { text: "يجمع كفيه ثم ينفث فيهما فيقرأ: سورة الإخلاص، والفلق، والناس. ثم يمسح بهما ما استطاع من جسده، يبدأ بهما على رأسه ووجهه وما أقبل من جسده.", count: "ثلاث مرات" },
            { text: "قراءة آية الكرسي.", count: "مرة واحدة", source: "لا يزال عليك من الله حافظ ولا يقربك شيطان حتى تصبح." },
            { text: "بِاسْمِكَ رَبِّـي وَضَعْـتُ جَنْـبي، وَبِكَ أَرْفَعُـه، فَإِن أَمْسَـكْتَ نَفْسـي فارْحَـمْها ، وَإِنْ أَرْسَلْتَـها فاحْفَظْـها بِمـا تَحْفَـظُ بِه عِبـادَكَ الصّـالِحـين.", count: "مرة واحدة" },
            { text: "اللّهُـمَّ قِنـي عَذابَـكَ يَـوْمَ تَبْـعَثُ عِبـادَك.", count: "ثلاث مرات" },
            { text: "الْحَمْـدُ لِلّهِ الَّذِي أَطْعَمَنَا وَسَقَانَا، وَكَفَانَا، وَآوَانَا، فَكَـمْ مِمَّـنْ لا كَافِيَ لَهُ وَلا مُـؤْوِي.", count: "مرة واحدة" },
            { text: "سُبْحَانَ اللَّهِ (33 مرة)، الْحَمْدُ لِلَّهِ (33 مرة)، اللَّهُ أَكْبَرُ (34 مرة).", count: "مرة واحدة" },
            { text: "اللّهُـمَّ عالِـمَ الغَـيبِ وَالشّـهادةِ فاطِـرَ السّماواتِ وَالأرْضِ رَبَّ كـلِّ شَـيءٍ وَمَليـكَه، أَشْهـدُ أَنْ لا إِلـهَ إِلاّ أَنْت، أَعـوذُ بِكَ مِن شَـرِّ نَفْسـي وَمِن شَـرِّ الشَّيْـطانِ وَشِرْكِهِ، وَأَنْ أَقْتَـرِفَ عَلـى نَفْسـي سوءاً أَوْ أَجُـرَّهُ إِلـى مُسْـلِم.", count: "مرة واحدة" },
            { text: "اللهم أسلمت نفسي إليك، وفوضت أمري إليك، ووجهت وجهي إليك، وألجأت ظهري إليك، رغبة ورهبة إليك، لا ملجأ ولا منجا منك إلا إليك، آمنت بكتابك الذي أنزلت، وبنبيك الذي أرسلت.", count: "مرة واحدة" },
            { text: "قراءة آخر آيتين من سورة البقرة.", count: "مرة واحدة", source: "من قرأهما في ليلة كفتاه." }
        ],
        salah: [
            { text: "أَسْتَغْفِرُ اللهَ (ثلاثاً). اللهم أَنْتَ السَّلاَمُ، وَمِنْكَ السَّلَامُ، تَبَارَكْتَ يَا ذَا الْجَلَالِ وَالْإِكْرَامِ." },
            { text: "لاَ إِلَهَ إِلاَّ اللَّهُ وَحْدَهُ لاَ شَرِيكَ لَهُ، لَهُ الْمُلْكُ، وَلَهُ الْحَمْدُ، وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ، اللَّهُمَّ لاَ مَانِعَ لِمَا أَعْطَيْتَ، وَلاَ مُعْطِيَ لِمَا مَنَعْتَ، وَلاَ يَنْفَعُ ذَا الْجَدِّ مِنْكَ الْجَدُّ." },
            { text: "سُبْحَانَ اللهِ (33)، الْحَمْدُ لِلَّهِ (33)، اللهُ أَكْبَرُ (33)، ثم يختم بـ 'لاَ إِلَهَ إِلاَّ اللَّهُ وَحْدَهُ لاَ شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ'." },
            { text: "قراءة آية الكرسي دبر كل صلاة مكتوبة." },
            { text: "قراءة المعوذات (الإخلاص والفلق والناس) دبر كل صلاة مكتوبة." },
            { text: "اللَّهُمَّ أَعِنِّي عَلَى ذِكْرِكَ وَشُكْرِكَ وَحُسْنِ عِبَادَتِكَ." },
            { text: "اللهم اغفر لي ما قدمت وما أخرت، وما أسررت وما أعلنت، وما أسرفت، وما أنت أعلم به مني، أنت المقدم وأنت المؤخر، لا إله إلا أنت." },
            { text: "اللهم إني أعوذ بك من الجبن، وأعوذ بك من البخل، وأعوذ بك من أن أرد إلى أرذل العمر، وأعوذ بك من فتنة الدنيا وعذاب القبر." },
            { text: "رب قني عذابك يوم تبعث عبادك." },
            { text: "اللهم إني أسألك علماً نافعاً، ورزقاً طيباً، وعملاً متقبلاً." }
        ],
        misc: [
            { text: "<b>عند الخروج من المنزل:</b> بِسْمِ اللهِ، تَوَكَّلْتُ عَلَى اللهِ، وَلَا حَوْلَ وَلَا قُوَّةَ إِلَّا بِاللهِ." },
            { text: "<b>عند الدخول إلى المنزل:</b> بِسْمِ اللهِ وَلَجْنَا، وَبِسْمِ اللهِ خَرَجْنَا، وَعَلَى رَبِّنَا تَوَكَّلْنَا." },
            { text: "<b>دعاء دخول المسجد:</b> أَعُوذُ بِاللَّهِ الْعَظِيمِ، وَبِوَجْهِهِ الْكَرِيمِ، وَسُلْطَانِهِ الْقَدِيمِ، مِنَ الشَّيْطَانِ الرَّجِيمِ." },
            { text: "<b>دعاء الخروج من المسجد:</b> بِسْمِ اللهِ وَالصّلاةُ وَالسّلامُ عَلَى رَسُولِ اللهِ، اللّهُمّ إِنّي أَسْأَلُكَ مِنْ فَضْلِكَ." },
            { text: "<b>دعاء الركوب:</b> سُبْحَانَ الَّذِي سَخَّرَ لَنَا هَذَا وَمَا كُنَّا لَهُ مُقْرِنِينَ، وَإِنَّا إِلَى رَبِّنَا لَمُنْقَلِبُونَ." },
            { text: "<b>دعاء السفر:</b> اللّهُمّ إِنّا نَسْأَلُكَ في سَفَرِنَا هَذَا البِرّ والتّقْوَى، وَمِنَ العَمَلِ مَا تَرْضَى." },
            { text: "<b>عند رؤية الهلال:</b> اللَّهُ أَكْبَرُ، اللَّهُمَّ أَهِلَّهُ عَلَيْنَا بِالْأَمْنِ وَالْإِيمَانِ، وَالسَّلَامَةِ وَالْإِسْلَامِ، وَالتَّوْفِيقِ لِمَا تُحِبُّ وَتَرْضَى، رَبُّنَا وَرَبُّكَ اللَّهُ." },
            { text: "<b>دعاء من استصعب عليه أمر:</b> اللَّهُمَّ لاَ سَهْلَ إِلاَّ مَا جَعَلْتَهُ سَهْلاً، وَأَنْتَ تَجْعَلُ الْحَزْنَ إِذَا شِئْتَ سَهْلاً." },
            { text: "<b>دعاء الكرب:</b> لاَ إِلَهَ إِلاَّ اللَّهُ الْعَظِيمُ الْحَلِيمُ، لاَ إِلَهَ إِلاَّ اللَّهُ رَبُّ الْعَرْشِ الْعَظِيمِ، لاَ إِلَهَ إِلاَّ اللَّهُ رَبُّ السَّمَوَاتِ وَرَبُّ الأَرْضِ وَرَبُّ الْعَرْشِ الْكَرِيمِ." },
            { text: "<b>دعاء لبس الثوب:</b> الْحَمْدُ لِلَّهِ الَّذِي كَسَانِي هَذَا (الثَّوْبَ) وَرَزَقَنِيهِ مِنْ غَيْرِ حَوْلٍ مِنِّي وَلا قُوَّةٍ." }
        ],
        tasabih: [ { text: 'سُبْحَانَ اللَّهِ وَبِحَمْدِهِ', id: 'tasabih1' }, { text: 'أَسْتَغْفِرُ اللَّهَ وَأَتُوبُ إِلَيْهِ', id: 'tasabih2' }, { text: 'لَا حَوْلَ وَلَا قُوَّةَ إِلَّا بِاللَّهِ', id: 'tasabih3' }, { text: 'اللهم صَلِّ وَسَلِّمْ عَلَى نَبِيِّنَا مُحَمَّدٍ', id: 'tasabih4' } ]
    };
    function createAzkarHTML(data) { return data.map(item => `<div class="azkar-item"><div class="azkar-text">${item.text}</div>${item.count ? `<div class="azkar-count">${item.count}</div>` : ''}${item.source ? `<p class="azkar-source">${item.source}</p>` : ''}</div>`).join(''); }
    function createTasabihHTML(data) { return data.map(item => `<div class="azkar-item"><div class="azkar-text">${item.text}</div><div class="counter"><button class="tasabih-counter-btn" onclick="updateTasabihCounter('${item.id}', -1)">-</button><div class="tasabih-counter-display" id="${item.id}-count">0 / 100</div><button class="tasabih-counter-btn" onclick="updateTasabihCounter('${item.id}', 1)">+</button></div></div>`).join(''); }
    for (const key in azkarData) {
        const container = document.getElementById(`azkar-${key}`);
        if (container) { container.innerHTML = key === 'tasabih' ? createTasabihHTML(azkarData[key]) : createAzkarHTML(azkarData[key]); }
    }
}

function populateDeceasedDuas() {
    const deceasedDataMale = [
        "اللهم اغفر له وارحمه، وعافه واعف عنه، وأكرم نزله، ووسع مدخله، واغسله بالماء والثلج والبرد، ونقه من الخطايا كما ينقى الثوب الأبيض من الدنس.",
        "اللهم أبدله داراً خيراً من داره، وأهلاً خيراً من أهله، وزوجاً خيراً من زوجه، وأدخله الجنة، وأعذه من عذاب القبر، ومن عذاب النار.",
        "اللهم اجعل قبره روضة من رياض الجنة، ولا تجعله حفرة من حفر النار.",
        "اللهم افسح له في قبره مد بصره، وافرش قبره من فراش الجنة.",
        "اللهم إنه في ذمتك وحبل جوارك، فقه فتنة القبر، وعذاب النار، وأنت أهل الوفاء والحق، فاغفر له وارحمه، إنك أنت الغفور الرحيم.",
        "اللهم إنه عبدك وابن عبدك، خرج من الدنيا، وسعتها، ومحبوبيه، وأحبائه فيها، إلى ظلمة القبر، وما هو لاقيه.",
        "اللهم عامله بما أنت أهله، ولا تعامله بما هو أهله.",
        "اللهم اجزه عن الإحسان إحساناً، وعن الإساءة عفواً وغفراناً.",
        "الل اللهم إن كان محسناً فزد من حسناته، وإن كان مسيئاً فتجاوز عن سيئاته.",
        "اللهم آنسه في وحدته، وفي وحشته، وفي غربته.",
        "اللهم أنزله منزلاً مباركاً، وأنت خير المنزلين.",
        "اللهم أنزله منازل الصديقين، والشهداء، والصالحين، وحسن أولئك رفيقاً.",
        "اللهم يمن كتابه، ويسر حسابه، وثقل بالحسنات ميزانه، وثبت على الصراط أقدامه، وأسكنه في أعلى الجنات، بجوار حبيبك ومصطفاك صلى الله عليه وسلم.",
        "اللهم املأ قبره بالرضا، والنور، والفسحة، والسرور.",
        "اللهم إنه كان يشهد أنك لا إله إلا أنت، وأن محمداً عبدك ورسولك، وأنت أعلم به.",
        "اللهم ثبته عند السؤال.",
        "اللهم إنا نتوسل بك إليك، ونقسم بك عليك أن ترحمه ولا تعذبه.",
        "اللهمّ شفّع فيه نبيّنا ومصطفاك، واحشره تحت لوائه، واسقه من يده الشريفة شربةً هنيئةً لا يظمأ بعدها أبداً.",
        "اللهم انقله من مواطن الدود، وضيق اللحود، إلى جنات الخلود.",
        "اللهم ارحمه تحت الأرض، واستره يوم العرض، ولا تخزه يوم يبعثون 'يوم لا ينفع مال ولا بنون إلا من أتى الله بقلب سليم'.",
        "اللهمّ يمّن كتابه، ويسّر حسابه، وثقّل بالحسنات ميزانه، وثبّت على الصّراط أقدامه، وأسكنه في أعلى الجنّات، بجوار حبيبك ومصطفاك صلّى الله عليه وسلّم.",
        "اللهمّ أمّنه من فزع يوم القيامة، ومن هول يوم القيامة، واجعل نفسه آمنةً مطمئنّةً، ولقّنه حجّته.",
        "اللهمّ اجعله في بطن القبر مطمئنّاً، وعند قيام الأشهاد آمناً، وبجود رضوانك واثقاً، وإلى أعلى درجاتك سابقاً.",
        "اللهم اجعل عن يمينه نوراً، حتّى تبعثه آمناً مطمئنّاً في نورٍ من نورك.",
        "اللهمّ انظر إليه نظرة رضا، فإنّ من تنظُر إليه نظرة رضاً لا تعذّبه أبداً.",
        "اللهمّ أسكنه فسيح الجنان، واغفر له يا رحمن، وارحمه يا رحيم، وتجاوز عمّا تعلم يا عليم.",
        "الل اللهمّ اعف عنه، فإنّك القائل 'ويعفو عن كثير'.",
        "اللهمّ إنّه جاء ببابك، وأناخ بجنابك، فَجُد عليه بعفوك، وإكرامك، وجود إحسانك.",
        "اللهمّ إنّ رحمتك وسعت كلّ شيء، فارحمه رحمةً تطمئنّ بها نفسه، وتقرّ بها عينه."
    ];
    const deceasedDataFemale = [
        "اللهم اغفر لها وارحمها وعافها واعف عنها، وأكرم نزلها ووسع مدخلها، واغسلها بالماء والثلج والبرد، ونقها من الخطايا كما ينقى الثوب الأبيض من الدنس.",
        "اللهم أبدلها داراً خيراً من دارها، وأهلاً خيراً من أهلها، وزوجاً خيراً من زوجها، وأدخلها الجنة وأعذها من عذاب القبر ومن عذاب النار.",
        "اللهم عاملها بما أنت أهله، ولا تعاملها بما هي أهله.",
        "اللهم اجزها عن الإحسان إحساناً، وعن الإساءة عفواً وغفراناً.",
        "اللهم إن كانت محسنة فزد من حسناتها، وإن كانت مسيئة فتجاوز عن سيئاتها.",
        "اللهم آنسها في وحدتها، وفي وحشتها، وفي غربتها.",
        "اللهم أنزلها منزلاً مباركاً، وأنت خير المنزلين.",
        "اللهم يمن كتابها، ويسر حسابها، وثقل بالحسنات ميزانها، وثبت على الصراط أقدامها، وأسكنها في أعلى الجنات، بجوار حبيبك ومصطفاك صلى الله عليه وسلم.",
        "اللهم املأ قبرها بالرضا، والنور، والفسحة، والسرور.",
        "اللهم إنها كانت تشهد أنك لا إله إلا أنت، وأن محمداً عبدك ورسولك، وأنت أعلم بها.",
        "اللهم ثبتها عند السؤال.",
        "اللهم إنا نتوسل بك إليك، ونقسم بك عليك أن ترحمها ولا تعذبها.",
        "اللهمّ شفّع فيها نبيّنا ومصطفاك، واحشرها تحت لوائه، واسقها من يده الشريفة شربةً هنيئةً لا تظمأ بعدها أبداً.",
        "اللهم انقلها من مواطن الدود، وضيق اللحود، إلى جنات الخلود.",
        "اللهم ارحمها تحت الأرض، واسترها يوم العرض، ولا تخزها يوم يبعثون 'يوم لا ينفع مال ولا بنون إلا من أتى الله بقلب سليم'.",
        "اللهمّ يمّن كتابها، ويسّر حسابها، وثقّل بالحسنات ميزانها، وثبّت على الصّراط أقدامها، وأسكنها في أعلى الجنّات، بجوار حبيبك ومصطفاك صلّى الله عليه وسلّم.",
        "اللهمّ أمّنها من فزع يوم القيامة، ومن هول يوم القيامة، واجعل نفسها آمنةً مطمئنّةً، ولقّنها حجّتها.",
        "اللهمّ اجعلها في بطن القبر مطمئنّةً، وعند قيام الأشهاد آمنةً، وبجود رضوانك واثقةً، وإلى أعلى درجاتك سابقةً.",
        "اللهم اجعل عن يمينها نوراً، حتّى تبعثها آمنةً مطمئنّةً في نورٍ من نورك.",
        "اللهمّ انظر إليها نظرة رضا، فإنّ من تنظُر إليه نظرة رضاً لا تعذّبه أبداً.",
        "اللهمّ أسكنها فسيح الجنان، واغفر لها يا رحمن، وارحمها يا رحيم، وتجاوز عمّا تعلم يا عليم.",
        "الل اللهمّ اعف عنها، فإنّك القائل 'ويعفو عن كثير'.",
        "اللهمّ إنّها جاءت ببابك، وأناخت بجنابك، فَجُد عليها بعفوك، وإكرامك، وجود إحسانك.",
        "اللهمّ إنّ رحمتك وسعت كلّ شيء، فارحمها رحمةً تطمئنّ بها نفسها، وتقرّ بها عينها."
    ];
    const nimerContainer = document.getElementById('deceased-nimer');
    const aishaContainer = document.getElementById('deceased-aisha');
    const basharContainer = document.getElementById('deceased-bashar');
    const basmaContainer = document.getElementById('deceased-basma');
    const generateHTML = (data) => data.map(dua => `<div class="dua-item"><div class="dua-text">${dua}</div></div>`).join('');
    nimerContainer.innerHTML = `<h3 class="card-title" style="font-size: 1.5rem;">أدعية للمرحوم بإذن الله نمر محمد عفانه</h3>` + generateHTML(deceasedDataMale);
    aishaContainer.innerHTML = `<h3 class="card-title" style="font-size: 1.5rem;">أدعية للمرحومة بإذن الله عائشة عواد الحمد</h3>` + generateHTML(deceasedDataFemale);
    basharContainer.innerHTML = nimerContainer.innerHTML.replace(/نمر محمد عفانه/g, 'بشار نمر عفانه');
    basmaContainer.innerHTML = aishaContainer.innerHTML.replace(/عائشة عواد الحمد/g, 'باسمة نمر عفانه');
}

function populateGeneralDuas() {
    const generalDuasData = [
        // أدعية قرآنية
        "رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الْآخِرَةِ حَسَنَةً وَقِنَا عَذَابَ النَّارِ.",
        "رَبَّنَا لَا تُزِغْ قُلُوبَنَا بَعْدَ إِذْ هَدَيْتَنَا وَهَبْ لَنَا مِن لَّدُنكَ رَحْمَةً إِنَّكَ أَنتَ الْوَهَّابُ.",
        "رَبَّنَا ظَلَمْنَا أَنفُسَنَا وَإِن لَّمْ تَغْفِرْ لَنَا وَتَرْحَمْنَا لَنَكُونَنَّ مِنَ الْخَاسِرِينَ.",
        "رَبِّ اشْرَحْ لِي صَدْرِي وَيَسِّرْ لِي أَمْرِي وَاحْلُلْ عُقْدَةً مِّن لِّسَانِي يَفْقَهُوا قَوْلِي.",
        "رَبَّنَا أَفْرِغْ عَلَيْنَا صَبْرًا وَثَبِّتْ أَقْدَامَنَا وَانصُرْنَا عَلَى الْقَوْمِ الْكَافِرِينَ.",
        "رَبَّنَا لَا تَجْعَلْنَا فِتْنَةً لِّلْقَوْمِ الظَّالِمِينَ وَنَجِّنَا بِرَحْمَتِكَ مِنَ الْقَوْمِ الْكَافِرِينَ.",
        "رَبَّنَا هَبْ لَنَا مِنْ أَزْوَاجِنَا وَذُرِّيَّاتِنَا قُرَّةَ أَعْيُنٍ وَاجْعَلْنَا لِلْمُتَّقِينَ إِمَامًا.",
        "رَبَّنَا تَقَبَّلْ مِنَّا إِنَّكَ أَنتَ السَّمِيعُ الْعَلِيمُ وَتُبْ عَلَيْنَا إِنَّكَ أَنتَ التَّوَّابُ الرَّحِيمُ.",
        "رَبِّ أَوْزِعْنِي أَنْ أَشْكُرَ نِعْمَتَكَ الَّتِي أَنْعَمْتَ عَلَيَّ وَعَلَى وَالِدَيَّ وَأَنْ أَعْمَلَ صَالِحًا تَرْضَاهُ وَأَدْخِلْنِي بِرَحْمَتِكَ فِي عِبَادِكَ الصَّالِحِينَ.",
        "رَبِّ إِنِّي لِمَا أَنزَلْتَ إِلَيَّ مِنْ خَيْرٍ فَقِيرٌ.",
        "لَّا إِلَهَ إِلَّا أَنتَ سُبْحَانَكَ إِنِّي كُنتُ مِنَ الظَّالِمِينَ.",
        "رَبَّنَا آتِنَا مِن لَّدُنكَ رَحْمَةً وَهَيِّئْ لَنَا مِنْ أَمْرِنَا رَشَدًا.",
        "رَبِّ زِدْنِي عِلْمًا.",
        "رَبَّنَا اغْفِرْ لِي وَلِوَالِدَيَّ وَلِلْمُؤْمِنِينَ يَوْمَ يَقُومُ الْحِسَابُ.",
        "رَبِّ هَبْ لِي مِنَ الصَّالِحِينَ.",
        // أدعية نبوية
        "اللَّهُمَّ إِنِّي أَسْأَلُكَ الْهُدَى وَالتُّقَى وَالْعَفَافَ وَالْغِنَى.",
        "يَا مُقَلِّبَ الْقُلُوبِ ثَبِّتْ قَلْبِي عَلَى دِينِكَ.",
        "اللَّهُمَّ أَعِنِّي عَلَى ذِكْرِكَ وَشُكْرِكَ وَحُسْنِ عِبَادَتِكَ.",
        "اللَّهُمَّ إنِّي أَعُوذُ بِكَ مِنْ زَوَالِ نِعْمَتِكَ، وَتَحَوُّلِ عَافِيَتِكَ، وَفُجَاءَةِ نِقْمَتِكَ، وَجَمِيعِ سَخَطِكَ.",
        "اللهم إني أعوذ بك من علم لا ينفع، ومن قلب لا يخشع، ومن نفس لا تشبع، ومن دعوة لا يستجاب لها.",
        "اللَّهُمَّ اهْدِنِي فِيمَنْ هَدَيْتَ، وَعَافِنِي فِيمَنْ عَافَيْتَ، وَتَوَلَّنِي فِيمَنْ تَوَلَّيْتَ، وَبَارِكْ لِي فِيمَا أَعْطَيْتَ، وَقِنِي شَرَّ مَا قَضَيْتَ، فَإِنَّكَ تَقْضِي وَلَا يُقْضَى عَلَيْكَ، إِنَّهُ لَا يَذِلُّ مَنْ وَالَيْتَ، تَبَارَكْتَ رَبَّنَا وَتَعَالَيْتَ.",
        "اللَّهُمَّ إِنِّي أَسْأَلُكَ مِنَ الْخَيْرِ كُلِّهِ عَاجِلِهِ وَآجِلِهِ، مَا عَلِمْتُ مِنْهُ وَمَا لَمْ أَعْلَمْ، وَأَعُوذُ بِكَ مِنَ الشَّرِّ كُلِّهِ عَاجِلِهِ وَآجِلِهِ، مَا عَلِمْتُ مِنْهُ وَمَا لَمْ أَعْلَمْ.",
        "اللَّهُمَّ إِنَّكَ عُفُوٌّ كَرِيمٌ تُحِبُّ الْعَفْوَ فَاعْفُ عَنِّي.",
        "حَسْبِيَ اللَّهُ لَا إِلَهَ إِلَّا هُوَ عَلَيْهِ تَوَكَّلْتُ وَهُوَ رَبُّ الْعَرْشِ الْعَظِيمِ.",
        "اللَّهُمَّ أَصْلِحْ لِي دِينِي الَّذِي هُوَ عِصْمَةُ أَمْرِي، وَأَصْلِحْ لِي دُنْيَايَ الَّتِي فِيهَا مَعَاشِي، وَأَصْلِحْ لِي آخِرَتِي الَّتِي فِيهَا مَعَادِي، وَاجْعَلِ الْحَيَاةَ زِيَادَةً لِي فِي كُلِّ خَيْرٍ، وَاجْعَلِ الْمَوْتَ رَاحَةً لِي مِنْ كُلِّ شَرٍّ.",
        "اللهم إني أسألك الجنة وما قرب إليها من قول أو عمل، وأعوذ بك من النار وما قرب إليها من قول أو عمل.",
        "اللهم إني أسألك من خير ما سألك عبدك ونبيك محمد صلى الله عليه وسلم، وأعوذ بك من شر ما عاذ به عبدك ونبيك محمد صلى الله عليه وسلم.",
        "اللَّهُمَّ اغْفِرْ لِي ذَنْبِي كُلَّهُ دِقَّهُ، وَجِلَّهُ، وَأَوَّلَهُ وَآخِرَهُ وَعَلَانِيَتَهُ وَسِرَّهُ.",
        "اللَّهُمَّ إِنِّي ظَلَمْتُ نَفْسِي ظُلْمًا كَثِيرًا، وَلَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ، فَاغْفِرْ لِي مَغْفِرَةً مِنْ عِنْدِكَ وَارْحَمْنِي إِنَّكَ أَنْتَ الْغَفُورُ الرَّحِيمُ.",
        "اللهم رحمتك أرجو فلا تكلني إلى نفسي طرفة عين، وأصلح لي شأني كله، لا إله إلا أنت.",
        "اللهم إني أعوذ بك من فتنة النار وعذاب النار، وفتنة القبر، وعذاب القبر، وشر فتنة الغنى، وشر فتنة الفقر.",
        "اللهم إني أعوذ بك من الكسل والهرم، والمأثم والمغرم.",
        "اللهم نقني من الخطايا كما ينقى الثوب الأبيض من الدنس.",
        "اللهم باعد بيني وبين خطاياي كما باعدت بين المشرق والمغرب.",
        "اللهم إني أسألك العفو والعافية في الدنيا والآخرة.",
        "اللهم إني أسألك موجبات رحمتك، وعزائم مغفرتك، والسلامة من كل إثم، والغنيمة من كل بر، والفوز بالجنة، والنجاة من النار.",
        "اللهم اجعل في قلبي نورًا، وفي لساني نورًا، وفي سمعي نورًا، وفي بصري نورًا، ومن فوقي نورًا، ومن تحتي نورًا، وعن يميني نورًا، وعن شمالي نورًا، ومن أمامي نورًا، ومن خلفي نورًا، واجعل في نفسي نورًا، وأعظم لي نورًا."
    ];
    const container = document.getElementById('general-duas-container');
    container.innerHTML = generalDuasData.map(dua => `<div class="dua-item"><div class="dua-text">${dua}</div></div>`).join('');
}


// --- 5. PRAYER TIMES (REFACTORED) ---

function initPrayerTimesBasedOnLocation() {
    const locationStatus = document.getElementById('location-status');
    locationStatus.innerHTML = "جاري تحديد موقعك... <br> (تأكد من تفعيل الموقع في جهازك/متصفحك)";
    
    const defaultLatitude = 31.9539; // Amman latitude
    const defaultLongitude = 35.9106; // Amman longitude
    const defaultCity = "عمان، الأردن (افتراضي)";

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                fetchPrayerTimes(position.coords.latitude, position.coords.longitude);
                updateLocationInfo(position.coords.latitude, position.coords.longitude);
            },
            (error) => {
                console.error('Error getting location:', error);
                locationStatus.innerHTML = `لا يمكن تحديد موقعك. <br> عرض مواقيت ${defaultCity}`;
                fetchPrayerTimes(defaultLatitude, defaultLongitude);
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 600000 }
        );
    } else {
        console.warn('Geolocation is not supported by this browser.');
        locationStatus.innerHTML = `خدمة تحديد الموقع غير مدعومة. <br> عرض مواقيت ${defaultCity}`;
        fetchPrayerTimes(defaultLatitude, defaultLongitude);
    }
}

async function fetchPrayerTimes(latitude, longitude) {
    // Method is hardcoded to 3 (Muslim World League) for simplicity and reliability
    const method = 3; 
    try {
        const response = await fetch(
            `https://api.aladhan.com/v1/timings?latitude=${latitude}&longitude=${longitude}&method=${method}`
        );
        const data = await response.json();
        
        if (data.code === 200 && data.status === "OK") {
            prayerTimesData = data.data.timings;
            displayPrayerTimes(prayerTimesData);
            startNextPrayerCountdown(prayerTimesData); // Pass data directly
        } else {
            document.getElementById('location-status').innerHTML += '<br> (خطأ في جلب مواقيت الصلاة)';
        }
    } catch (error) {
        console.error('Error during fetchPrayerTimes:', error);
        document.getElementById('location-status').innerHTML += '<br> (فشل الاتصال بخادم مواقيت الصلاة)';
    }
}

async function updateLocationInfo(latitude, longitude) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=10&addressdetails=1`
        );
        const data = await response.json();
        let locationName = '';
        if (data.address) {
            locationName = data.address.city || data.address.town || data.address.village || data.address.county || data.address.state || 'موقعك الحالي';
            if (data.address.country) {
                locationName += `, ${data.address.country}`;
            }
        } else {
            locationName = 'موقعك الحالي';
        }
        document.getElementById('location-status').textContent = `مواقيت الصلاة في: ${locationName}`;
    } catch (error) {
        console.error('Error fetching location name:', error);
        document.getElementById('location-status').textContent = 'مواقيت الصلاة لموقعك الحالي';
    }
}

function displayPrayerTimes(times) {
    if (!times) return;
    document.getElementById('fajr-time').textContent = formatTo12Hour(times.Fajr);
    document.getElementById('sunrise-time').textContent = formatTo12Hour(times.Sunrise);
    document.getElementById('dhuhr-time').textContent = formatTo12Hour(times.Dhuhr);
    document.getElementById('asr-time').textContent = formatTo12Hour(times.Asr);
    document.getElementById('maghrib-time').textContent = formatTo12Hour(times.Maghrib); 
    document.getElementById('isha-time').textContent = formatTo12Hour(times.Isha);
}

// --- COUNTDOWN TIMER (REWRITTEN FOR RELIABILITY) ---
function startNextPrayerCountdown(times) {
    if (nextPrayerInterval) clearInterval(nextPrayerInterval);
    if (!times || Object.keys(times).length === 0) return;

    const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
    const prayerNamesArabic = {
        Fajr: 'الفجر', Dhuhr: 'الظهر', Asr: 'العصر', Maghrib: 'المغرب', Isha: 'العشاء', Sunrise: 'الشروق'
    };

    nextPrayerInterval = setInterval(() => {
        const now = new Date();
        let nextPrayerName = null;
        let nextPrayerTime = null;

        // 1. Create date objects for all of today's prayers
        const todayPrayerTimes = prayerOrder.map(prayerName => {
            const [hours, minutes] = times[prayerName].split(':');
            const prayerDate = new Date();
            prayerDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            return { name: prayerName, date: prayerDate };
        });

        // 2. Find the first prayer that is in the future
        for (const prayer of todayPrayerTimes) {
            if (prayer.date > now) {
                nextPrayerName = prayer.name;
                nextPrayerTime = prayer.date;
                break;
            }
        }

        // 3. If all prayers have passed, the next prayer is Fajr tomorrow
        if (!nextPrayerTime) {
            nextPrayerName = 'Fajr';
            const [hours, minutes] = times.Fajr.split(':');
            nextPrayerTime = new Date();
            nextPrayerTime.setDate(nextPrayerTime.getDate() + 1); // Move to tomorrow
            nextPrayerTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
        }

        // 4. Update UI (highlighting and countdown text)
        document.querySelectorAll('.prayer-item').forEach(item => item.classList.remove('next-prayer'));
        const nextPrayerElement = document.getElementById(`prayer-${nextPrayerName}`);
        if(nextPrayerElement) {
            nextPrayerElement.classList.add('next-prayer');
        }

        const diff = nextPrayerTime - now;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        document.getElementById('next-prayer-countdown').textContent = 
            `${prayerNamesArabic[nextPrayerName]} بعد ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

    }, 1000);
}


function formatTo12Hour(time) {
    if (!time || typeof time !== 'string') return '--:--';
    const [hourStr, minuteStr] = time.split(':');
    let hour = parseInt(hourStr, 10);
    const suffix = hour >= 12 ? 'مساءً' : 'صباحًا';
    hour = hour % 12;
    hour = hour === 0 ? 12 : hour; // Convert 0 to 12 for 12-hour format
    return `${hour.toString().padStart(2, '0')}:${minuteStr} ${suffix}`;
}


// --- 6. QIBLA ---
function initNewQibla() {
    const permissionContainer = document.getElementById('qibla-permission-container');
    const statusText = document.getElementById('qibla-status-new');
    const compassDial = document.getElementById('compass-dial-new');
    const kaabaMarker = document.getElementById('kaaba-marker-new');
    const qiblaCitySpan = document.getElementById('qibla-city');

    statusText.textContent = '';
    permissionContainer.textContent = '';
    qiblaCitySpan.textContent = 'جاري التحديد...';

    const qiblaLocationSuccess = async (position) => {
        const { latitude, longitude } = position.coords;
        const qiblaBearing = calculateQiblaBearing(latitude, longitude);
        
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=10&addressdetails=1`);
            const data = await response.json();
            if (data.address) {
                const city = data.address.city || data.address.town || data.address.village || 'موقعك الحالي';
                qiblaCitySpan.textContent = city;
            } else {
                qiblaCitySpan.textContent = 'موقعك الحالي';
            }
        } catch (error) {
            console.error('Error fetching Qibla location name:', error);
            qiblaCitySpan.textContent = 'موقعك الحالي (فشل عرض الاسم)';
        }

        kaabaMarker.style.transform = `rotate(${qiblaBearing}deg)`;

        let lastVibrationTime = 0;
        
        orientationHandler = (event) => {
            let heading = event.alpha; // For Android
            if (event.webkitCompassHeading !== undefined && event.webkitCompassHeading !== null) {
                heading = event.webkitCompassHeading; // For iOS
            }
            if (heading === null || heading === undefined) {
                statusText.textContent = 'البوصلة غير متوفرة أو تحتاج لمعايرة (حرك الجهاز في شكل 8)';
                compassDial.style.transform = `rotate(0deg)`;
                return;
            }

            compassDial.style.transform = `rotate(${-heading}deg)`;
            
            const currentQiblaAngleOnDial = (qiblaBearing - heading + 360) % 360;
            const isAligned = Math.min(currentQiblaAngleOnDial, 360 - currentQiblaAngleOnDial) < 3; // 3-degree tolerance

            if (isAligned) {
                statusText.textContent = 'الجهاز يشير إلى اتجاه القبلة';
                const now = Date.now();
                if (navigator.vibrate && now - lastVibrationTime > 2000) {
                    navigator.vibrate(100);
                    lastVibrationTime = now;
                }
            } else {
                statusText.textContent = 'قم بتدوير الجهاز حتى تتطابق الكعبة مع الأعلى';
            }
        };

        if ('DeviceOrientationEvent' in window && typeof DeviceOrientationEvent.requestPermission === 'function') {
            permissionContainer.innerHTML = '<button id="qibla-permission-btn">تفعيل البوصلة</button>';
            document.getElementById('qibla-permission-btn').onclick = () => {
                DeviceOrientationEvent.requestPermission().then(permissionState => {
                    if (permissionState === 'granted') {
                        permissionContainer.innerHTML = '';
                        window.addEventListener('deviceorientation', orientationHandler);
                        statusText.textContent = 'البوصلة مفعلة، حرك الجهاز.';
                    } else {
                        statusText.textContent = 'تم رفض إذن استخدام البوصلة.';
                    }
                }).catch(() => statusText.textContent = 'حدث خطأ عند طلب الإذن.');
            };
        } else {
             window.addEventListener('deviceorientation', orientationHandler);
             statusText.textContent = 'البوصلة مفعلة، حرك الجهاز.';
        }
    };

    const qiblaLocationError = () => {
        statusText.textContent = 'لا يمكن تحديد موقعك لتحديد اتجاه القبلة. تأكد من تفعيل الموقع في جهازك.';
        qiblaCitySpan.textContent = 'غير معروف';
    };

    permissionContainer.textContent = 'جاري طلب أذونات الموقع...';
    navigator.geolocation.getCurrentPosition(qiblaLocationSuccess, qiblaLocationError, { enableHighAccuracy: true });
}

function stopQibla() {
    if (orientationHandler) {
        window.removeEventListener('deviceorientation', orientationHandler);
        orientationHandler = null;
    }
}

function calculateQiblaBearing(lat1, lon1) {
    const toRad = (deg) => deg * Math.PI / 180;
    const toDeg = (rad) => rad * 180 / Math.PI;

    lat1 = toRad(lat1);
    lon1 = toRad(lon1);
    const lat2 = toRad(KABA_LAT);
    const lon2 = toRad(KABA_LON);

    const deltaLon = lon2 - lon1;
    const y = Math.sin(deltaLon) * Math.cos(lat2);
    const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(deltaLon);
    let bearing = toDeg(Math.atan2(y, x));
    return (bearing + 360) % 360;
}


// --- 7. QURAN READER & OTHERS ---
async function loadQuranIndex() {
    const indexDiv = document.getElementById('quran-index');
    const loader = document.getElementById('quran-index-loader');
    try {
        const response = await fetch('https://api.alquran.cloud/v1/surah');
        const data = await response.json();
        if(data.code === 200) {
            loader.style.display = 'none';
            data.data.forEach(surah => {
                const btn = document.createElement('button');
                btn.className = 'surah-btn';
                btn.innerHTML = `<div class="surah-number">${surah.number}</div> <div class="surah-details">${surah.name} <span>${surah.revelationType === 'Meccan' ? 'مكية' : 'مدنية'} - ${surah.numberOfAyahs} آية</span></div>`;
                btn.onclick = () => loadSurah(surah.number);
                indexDiv.appendChild(btn);
            });
        } else { loader.textContent = 'حدث خطأ.'; }
    } catch (error) { loader.textContent = 'فشل الاتصال بالإنترنت.'; }
}

async function loadSurah(surahNumber) {
    document.getElementById('quran-index-container').style.display = 'none';
    const viewer = document.getElementById('quran-viewer');
    const contentDiv = document.getElementById('surah-content');
    viewer.style.display = 'block';
    contentDiv.innerHTML = '<div style="text-align:center; font-size: 1.2rem;">جاري تحميل السورة...</div>';
    try {
        const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}`);
        const data = await response.json();
        if (data.code === 200) {
            const surah = data.data;
            document.getElementById('surah-title').textContent = `سورة ${surah.name}`;
            document.getElementById('surah-bismillah').textContent = (surah.number !== 9 && surah.number !== 1) ? 'بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ' : '';
            contentDiv.innerHTML = surah.ayahs.map(ayah => {
                let ayahText = ayah.text;
                if (surah.number === 1 && ayah.numberInSurah === 1) {
                    ayahText = ayahText.replace('بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ', '');
                }
                return `<div class="ayah">${ayahText}<span class="ayah-number">${ayah.numberInSurah}</span></div>`;
            }).join('');
            document.querySelector('#quran-viewer .content-section').scrollTop = 0;
        } else { contentDiv.innerHTML = '<div style="text-align:center;">حدث خطأ.</div>'; }
    } catch (error) { contentDiv.innerHTML = '<div style="text-align:center;">فشل الاتصال بالإنترنت.</div>'; }
}

function showQuranIndex() {
    document.getElementById('quran-viewer').style.display = 'none';
    document.getElementById('quran-index-container').style.display = 'block';
}

function updateTasabihCounter(id, change) {
    const display = document.getElementById(id + '-count');
    if (!display) return;
    let [count, max] = display.textContent.split(' / ').map(Number);
    count = Math.max(0, count + change);
    display.textContent = `${count} / ${max}`;
    localStorage.setItem(id, count);
}

function loadAllTasabihCounters() {
    document.querySelectorAll('.tasabih-counter-display').forEach(el => {
        const id = el.id.replace('-count', '');
        const savedCount = localStorage.getItem(id);
        if (savedCount !== null) {
            el.textContent = `${savedCount} / ${el.textContent.split(' / ')[1]}`;
        }
    });
}
</script>
</body>
</html>
